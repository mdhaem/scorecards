<!DOCTYPE html>
<html>
<head lang="en">
	<?php
	  $browser = strpos($_SERVER['HTTP_USER_AGENT'],"iPhone");
	    if ($browser == true){
	    $browser = 'iphone';
	  }
	?> 
	
	<?php if($browser == 'iphone'){ ?>
	  <meta name="viewport"
	  content="width=device-width,
	  minimum-scale=1.0, maximum-scale=1.0" />
	<?php } ?>
	
    <meta charset="UTF-8">
    <title>iScoreCards</title>
	<link rel="apple-touch-icon" href="iPhoneIcon_Small.png">
    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="jquery-dateFormat.min.js"></script>
    <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>
	<h2>iScoreCards</h2>
<form>
    <div id="cardgameselectdiv">
        <select id="selectcardgame">
			<option value="0">Select game...</option>
        </select>
		<p id="selectedgame">
    </div>
	
    <div id="cardgameplayergroupdiv">
        <select id="selectplayergroup">
			<option value="0">Select player group...</option>
        </select>
    </div>
	
<dev id="shanghaiscorecard">
    <p><input type="button" id="tally" value="Tally" /></p>
	<br/>
<table id="shanghiatable">
	<tr id=history>
        <td class="scorecardsidemenu">Games Won</td>
        <td id="historyone">0</td>
        <td id="historytwo">0</td>
        <td id="historythree">0</td>
        <td id="historyfour">0</td>
	</tr>
    <tr>
        <td class="scorecardsidemenu">Totals</td>
        <td><input id="scoretotalone" type="number" value="0" /></td>
        <td><input id="scoretotaltwo" type="number" value="0" /></td>
        <td><input id="scoretotalthree" type="number" value="0" /></td>
        <td><input id="scoretotalfour" type="number" value="0" /></td>
    </tr>
    <tr id="scorecardnamerow">
        <td class="scorecardsidemenu"></td>
        <!--<td id="0-1" class="playername" value="1">Bill</td>
        <td id="0-2" class="playername" value="2">Bev</td>
        <td id="0-3" class="playername" value="3">Mike</td>
        <td id="0-4" class="playername" value="4">Sandy</td>-->
    </tr>
    <tr>
        <td class="scorecardsidemenu">6</td>
        <td><input class="scoreplayerone" type="number" /></td>
        <td><input class="scoreplayertwo" type="number" /></td>
        <td><input class="scoreplayerthree" type="number" /></td>
        <td><input class="scoreplayerfour" type="number" /></td>
    </tr>
    <tr>
        <td class="scorecardsidemenu">7</td>
        <td><input class="scoreplayerone" type="number" /></td>
        <td><input class="scoreplayertwo" type="number" /></td>
        <td><input class="scoreplayerthree" type="number" /></td>
        <td><input class="scoreplayerfour" type="number" /></td>
    </tr>
    <tr>
        <td class="scorecardsidemenu">8</td>
        <td><input class="scoreplayerone" type="number" /></td>
        <td><input class="scoreplayertwo" type="number" /></td>
        <td><input class="scoreplayerthree" type="number" /></td>
        <td><input class="scoreplayerfour" type="number" /></td>
    </tr>
    <tr>
        <td class="scorecardsidemenu">9</td>
        <td><input class="scoreplayerone" type="number" /></td>
        <td><input class="scoreplayertwo" type="number" /></td>
        <td><input class="scoreplayerthree" type="number" /></td>
        <td><input class="scoreplayerfour" type="number" /></td>
    </tr>
    <tr>
        <td class="scorecardsidemenu">10</td>
        <td><input class="scoreplayerone" type="number" /></td>
        <td><input class="scoreplayertwo" type="number" /></td>
        <td><input class="scoreplayerthree" type="number" /></td>
        <td><input class="scoreplayerfour" type="number" /></td>
    </tr>
    <tr>
        <td class="scorecardsidemenu">11</td>
        <td><input class="scoreplayerone" type="text" /></td>
        <td><input class="scoreplayertwo" type="text" /></td>
        <td><input class="scoreplayerthree" type="text" /></td>
        <td><input class="scoreplayerfour" type="text" /></td>
    </tr>
    <tr>
        <td class="scorecardsidemenu">12</td>
        <td><input id="12-1" class="scoreplayerone" type="number" /></td>
        <td><input id="12-2" class="scoreplayertwo" type="number" /></td>
        <td><input id="12-3" class="scoreplayerthree" type="number" /></td>
        <td><input id="12-4" class="scoreplayerfour" type="number" /></td>
    </tr>
</table>
<br/>
    <input type="button" id="savescores" value="Save Scores" disabled="true" />
</dev>
</form>
<input id="cardgame" type="hidden" name="cardGame" value="0" />
<input id="team" type="hidden" name="team" value="0" />
<input id="game" type="hidden" name="game" value="1" />
<script>
$( document ).ready(function(){
	
    $.ajax({
        type: "GET",
        url: "http://doihaveit.net/service/CardGame.php?method=getCardGames",
        dataType: "json",
        success: function(resp){
            // we have the response
            //alert("Succes data returned is:\n '" + resp + "'");
            //alert(resp.length);
            var html = '';
            var len = resp.length;
            for (var i = 0; i< len; i++) {
                html += '<option value="' + resp[i].idCardGame + '">' + resp[i].cardGameName + '</option>';
            }
            //alert(html);
            $('#selectcardgame').append(html);

        },
        error: function(xhr, status, error) {
            //var err = eval("(" + xhr.responseText + ")");
            alert(xhr.responseText + error + status);
        }

    });

	///SELECTED GAME
    $( "#selectcardgame" ).change(function() {
		
		///IF CARDGAME HAS NOT CHANGED THEN INCREMENT GAME COUNT
		if($("#cardgame").attr('value') === $("#selectcardgame option:selected" ).attr('value')){
			var counter = $("#game").val($("#cardgame").attr('value'));
			counter++;
			$("#game").val(counter);
		} 
		
		///SET CARDGAME HIDDEN VALUE
		$( "#cardgame" ).val($("#selectcardgame option:selected" ).attr('value'));
		
		///DISPLAY PLAYER GROUP SELECT AND POPULATE WITH GROUP NAMES
        $("#selectplayergroup").css('display','inline');
        getGroupNames();
    });
	
	///SELECTED PLAYER GROUP
    $( "#selectplayergroup" ).change(function() {
		
		///DISPLAY AND POPULATE PLAYER GROUP SELECT
        $("#cardgameplayergroupdiv").css('display','inline');
		$("#shanghaiscorecard").css('display','inline');
		populatePlayerNames($("#selectplayergroup option:selected" ).attr('value'));
		
		///POPULATE HISTORY
		getHistory();
		
		///POPULATE HIDDEN INPUT
		$( "#team" ).val($("#selectplayergroup option:selected" ).attr('value'));
		
		//alert($("#team" ).attr('value'));
		
		///HIDE GAME AND TEAM SELECTS
		$("#cardgameselectdiv").css('display','none');
		$("#cardgameplayergroupdiv").css('display','none');
		$("#selectcardgame").css('display','none');
		$("#selectplayergroup").css('display','none');
    });

	///CALCULATE GAME TOTALS WHEN TALLY BUTTON IS CLICKED
    $("#tally").click(function(){
        calculateSum();
        calculateSumOfTwelve();
    });

	///AUTOMATIC SCORE TALLY
    $(".scoreplayerone,.scoreplayertwo,.scoreplayerthree,.scoreplayerfour").change(function(){

        var row = $(this).closest('tr');
        var scoreplayerone = parseFloat(row.find('.scoreplayerone').val());
        var scoreplayertwo = parseFloat(row.find('.scoreplayertwo').val());
        var scoreplayerthree = parseFloat(row.find('.scoreplayerthree').val());
        var scoreplayerfour = parseFloat(row.find('.scoreplayerfour').val());

        if($.isNumeric(scoreplayerone) && $.isNumeric(scoreplayertwo) && $.isNumeric(scoreplayerthree) && $.isNumeric(scoreplayerfour)) {
            calculateSum();
			calculateSumOfTwelve();
        }
    });

	///SAVE GAME SCORES
    $("#savescores").click(function(){
		//alert("Save Score Clicked");
		saveGameScores();
		$("#savescores").css('display','none');
		$("#tally").css('display','none');
    });
});

///GET PLAYERS HISTORY
function getHistory(){
	var playersHistory = ["#historyone", "#historytwo", "#historythree", "#historyfour"];
    $.ajax({
        type: "GET",
        url: "http://doihaveit.net/service/CardGame.php?method=getHistory",
        dataType: "json",
        success: function(resp){
            var html = '';
            var len = resp.length;
            for (var i = 0; i< len; i++) {
				alert("idPlayer"+resp[i].idPlayer);
				alert("playersHistory" + $(playersHistory[resp[i].idPlayer]));
                $(playersHistory[(resp[i].idPlayer)-1]).html(resp[i].won);
            }
        },
        error: function(xhr, status, error) {
            //var err = eval("(" + xhr.responseText + ")");
            alert(xhr.responseText + error + status);
        }

    });
}

function getDate(){
	var d = new Date();
	var y = d.getFullYear();
	var m = d.getMonth()+1;
	var D = d.getDate();
	//alert(y+'-'+m+'-'+D);
	
	return y+'-'+m+'-'+D;
}

function saveScore(idplayer, score, winner){
	//($("#cardgame").attr('value'));
	//alert($("#team").attr('value'));
	var URL = "http://doihaveit.net/service/CardGame.php?method=saveScore&idCardGame=" +
		$("#cardgame").attr('value') +
		"&idplayer=" +
		idplayer +
		"&score=" + 
		score +
		"&winner=" +
		winner +
		"&date=" +
		getDate() +
		"&team=" +
		$("#team").attr('value') +
		"&game=" +
		$("#game").attr('value');
	
	//alert(URL);
	
	$.ajax({
    	type: "POST",
    	//url: "http://doihaveit.net/service/CardGame.php?method=saveScore&idCardGame=1&idplayer=1&score=55&winner=true&date=2014-08-09&team=1&game=1",
		url: URL,
		dataType: 'text',
		success: function(rsp) {},
        error: function(xhr, status, error) {
            //var err = eval("(" + xhr.responseText + ")");
            alert("ERROR: " + xhr.responseText + error + status);
        }
	});
					
	return;
}

	function saveGameScores(){
		var i = 0;
		var playergametotal = ["#scoretotalone", "#scoretotaltwo", "#scoretotalthree", "#scoretotalfour"];
		//var idGame = $("#selectcardgame option:selected" ).attr('value');
		//var idPlayerGroup = $("#selectplayergroup option:selected" ).attr('value');
		//alert(idGame);
		//alert(idPlayerGroup);
		var names = {};
		var players = $(".playername").toArray();
		$( ".playername" ).each(function() {
		    names[ $(this).attr('id') ] = $(players[i]).attr('value');
			//alert( $(this).attr('id') );
			//alert( $(players[i]).attr('value') ); //PLAYER ID
			//alert( $(players[i]).html() );//PLAYER NAME
			//alert(playergametotal[i]);
			//alert( $(playergametotal[i]).val());
			var winner = false;
			//alert("whoiswinner = " + whoiswinner());
			//alert( playergametotal[i] + " = " + $(playergametotal[i]).val());
			if($(playergametotal[i]).val() == whoiswinner()){
				winner = true;
			}
			saveScore($(players[i]).attr('value'), $(playergametotal[i]).val(), winner);
			i++;
		});
	}
	
	function whoiswinner(){
		var _array = [$("#scoretotalone").val(),$("#scoretotaltwo").val(),$("#scoretotalthree").val(),$("#scoretotalfour").val()];
		//var _array = [10,20,30,40];
		//Math.max.apply(Math,_array);
		return Math.min.apply(Math,_array); 
	}

	function populatePlayerNames(groupName){
	    $.ajax({
	        type: "GET",
	        url: "http://doihaveit.net/service/CardGame.php?method=populateScoreCardNames&groupname="+groupName,
	        dataType: "json",
	        success: function(resp){
	            var html = '';
	            var len = resp.length;
	            for (var i = 0; i< len; i++) {
					var arr = (resp[i].playerName).split(' ');
	                html += '<td class="playername" value="' + resp[i].idPlayer + '">' + arr[0] + '</td>';
	            }
	            //alert(html);
	            $('#scorecardnamerow').append(html);

	        },
	        error: function(xhr, status, error) {
	            //var err = eval("(" + xhr.responseText + ")");
	            alert(xhr.responseText + error + status);
	        }

	    });
	}
	


    function getGroupNames() {
        $.ajax({
            type: "GET",
            url: "http://doihaveit.net/service/CardGame.php?method=getgroupnames",
            dataType: "json",
            success: function(resp){
                // we have the response
                //alert("Success data returned is:\n '" + resp + "'");
                //alert(resp.length);
                var html = '';
                var len = resp.length;
                for (var i = 0; i< len; i++) {
                    html += '<option value="' + resp[i].idGroupName + '">' + resp[i].groupName + '</option>';
                }
                //alert(html);
                $('#selectplayergroup').append(html);

            },
            error: function(xhr, status, error) {
                alert(xhr.responseText + error + status);
            }

        });
    }

    function calculateSum() {
        var sum = 0;
        var players = {".scoreplayerone": "#scoretotalone", ".scoreplayertwo": "#scoretotaltwo", ".scoreplayerthree": "#scoretotalthree", ".scoreplayerfour": "#scoretotalfour"};
        for (var key in players) {

            var score = key;
            var total = players[key];
            var sum = 0;

            $(score).each(function () {
                if (!isNaN(this.value) && this.value.length != 0) {
                    sum += parseInt(this.value);
                }
            });

            $(total).val(sum);
        }
    }

	function calculateSumOfTwelve() {
    	var sum = 0;
    	var finalScoreCount = 0;
    	var playersLastScore = ["#12-1", "#12-2", "#12-3", "#12-4"];
    	//alert("Got to for loop!");
    	for(var lastScore in playersLastScore){
        	//alert("lastScore "+playersLastScore[lastScore]);
        	$(playersLastScore[lastScore]).each(function () {
            	if (!isNaN(this.value) && this.value.length != 0) {
                	sum += parseInt(this.value);
                	finalScoreCount += 1;
            	}
        	});
    }

	//alert("finalScoreCount" + finalScoreCount);
    if(finalScoreCount == 4){
		$("#tally").attr("disabled",true);
        $("#savescores").attr("disabled",false);
    }
	
}
</script>
</body>

</html>
